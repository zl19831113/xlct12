<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小鹿题库系统 - 智能组卷</title>
    <link rel="stylesheet" href="/static/css/header.css">
    <style>
        :root {
            --primary-color: #4a6fc2;
            --secondary-color: #f5f8fe;
            --accent-color: #6b8dd6;
            --success-color: #4caf50;
            --warning-color: #ffb74d;
            --error-color: #e57373;
            --bg-color: #ffffff;
            --bg-light: #f9fafc;
            --text-primary: #333333;
            --text-secondary: #757575;
            --text-subheading: #5c5c5c;
            --border-color: #e1e8f0;
            --border-radius: 8px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            background-color: var(--bg-light);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: flex;
            flex-wrap: wrap;
        }
        
        .main-content {
            flex: 1;
            min-width: 0;
            margin-left: 300px; /* 为侧边栏预留空间 */
        }
        
        /* 标题样式 */
        .page-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--primary-color);
        }
        
        /* 卡片样式 */
        .card {
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        /* 左侧筛选侧边栏样式 */
        .filter-sidebar {
            width: 280px;
            flex-shrink: 0;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        /* 只在标准或大屏幕设备上有固定底部定位 */
        @media (min-width: 992px) {
            .filter-sidebar {
                position: fixed;
                left: max(calc((100% - 1200px) / 2 + 16px), 16px);
                top: 150px; /* 从100px调整到150px，让筛选栏下移 */
                max-height: calc(100vh - 170px);
                z-index: 100;
            }
        }
        
        /* 筛选部分样式 */
        .filter-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .filter-input-group {
            margin-bottom: 15px;
        }
        
        .filter-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-subheading);
        }
        
        .filter-input-group select,
        .filter-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        
        .filter-input-group select:focus,
        .filter-input-group input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .filter-input-group select:disabled {
            background-color: #f3f3f3;
            cursor: not-allowed;
        }
        
        /* 题型选择部分样式 */
        .question-types-container {
            margin-bottom: 20px;
        }
        
        .question-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            cursor: move;
            transition: background-color 0.2s;
        }
        
        .question-type-item:hover {
            background-color: var(--secondary-color);
        }
        
        .question-type-item.dragging {
            opacity: 0.5;
            background-color: var(--accent-color);
            color: white;
        }
        
        .type-info {
            display: flex;
            align-items: center;
        }
        
        .drag-handle {
            margin-right: 10px;
            color: var(--text-secondary);
            cursor: grab;
        }
        
        .question-count-input {
            width: 60px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        /* 听力题型组样式 */
        .question-type-group {
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px;
            background-color: var(--bg-light);
        }
        
        .question-type-header {
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .listening-subtype {
            margin-left: 10px;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            margin-bottom: 5px;
            padding: 5px;
        }
        
        /* 按钮样式 */
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .button-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .button-primary:hover {
            background-color: var(--accent-color);
        }
        
        .button-primary:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* 题目生成结果部分 */
        .generation-result {
            margin-top: 20px;
            display: none;
        }
        
        .result-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        /* 消息提示 */
        .message {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        
        .message-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #0d47a1;
        }
        
        .message-success {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #1b5e20;
        }
        
        .message-error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #b71c1c;
        }
        
        /* 加载指示器 */
        .loading-indicator {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            margin: 0 auto 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 移动设备适配 */
        @media (max-width: 991px) {
            .container {
                flex-direction: column;
            }
            
            .filter-sidebar {
                width: 100%;
                position: static;
                margin-bottom: 20px;
                max-height: none;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        /* 纸张预览样式 */
        .paper-preview {
            background-color: white;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            border-radius: 2px;
        }
        
        /* 题目列表样式 */
        .question-list {
            counter-reset: question;
        }
        
        .question-item {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .question-item:before {
            counter-increment: question;
            content: counter(question) ". ";
            font-weight: bold;
        }
        
        .paper-title-input-container {
            margin-bottom: 20px;
            padding: 12px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .paper-title-input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-subheading);
        }
        
        .paper-title-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- 引入公共头部组件 -->
    {% include 'header.html' %}

    <div class="container">
        <!-- 左侧筛选栏 -->
        <div class="filter-sidebar">
            <div class="card">
                <h2 class="section-title">筛选条件</h2>
                
                <!-- 基础筛选 -->
                <div class="filter-section">
                    <div class="filter-input-group">
                        <label for="educationStage">学段</label>
                        <select id="educationStage">
                            <option value="">选择学段</option>
                            <option value="小学">小学</option>
                            <option value="初中">初中</option>
                            <option value="高中">高中</option>
                        </select>
                    </div>
                    
                    <div class="filter-input-group">
                        <label for="subject">科目</label>
                        <select id="subject" disabled>
                            <option value="">选择科目</option>
                        </select>
                    </div>
                    
                    <div class="filter-input-group">
                        <label for="chapter">章节</label>
                        <select id="chapter" disabled>
                            <option value="">选择章节</option>
                        </select>
                    </div>
                    
                    <div class="filter-input-group">
                        <label for="unit">单元</label>
                        <select id="unit" disabled>
                            <option value="">选择单元</option>
                        </select>
                    </div>
                    
                    <div class="filter-input-group">
                        <label for="lesson">课程</label>
                        <select id="lesson" disabled>
                            <option value="">选择课程</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 题型选择部分 -->
            <div class="question-types-container">
                <h2 class="section-title">题型和题目数量选择</h2>
                <p>请选择您需要的题型和数量，拖动可调整题型顺序。总题目数量不超过50题。</p>
                
                <!-- 添加试卷名称输入框 -->
                <div class="paper-title-input-container">
                    <label for="paperTitleInput">试卷名称</label>
                    <input type="text" id="paperTitleInput" class="paper-title-input" placeholder="请输入试卷名称" value="智能组卷试题">
                </div>
                
                <div id="questionTypesContainer">
                    <!-- 题型列表将通过JavaScript动态生成 -->
                    <div class="question-type-item" data-type="单选题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">单选题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="10" data-type="单选题">
                    </div>
                </div>
                
                <div id="totalCountDisplay">总题目数：<span id="totalCount">0</span>/50</div>
                
                <button id="generateBtn" class="button button-primary" onclick="generatePaper()" disabled>生成试卷</button>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="card">
                <h1 class="page-title">智能试卷组卷</h1>
                
                <p>根据筛选条件自动生成试卷，可选择题型和数量。</p>
                
                <!-- 显示生成进度 -->
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="spinner"></div>
                    <p>正在生成试卷，请稍候...</p>
                </div>
                
                <!-- 消息提示 -->
                <div id="messageBox" class="message" style="display: none;"></div>
                
                <!-- 生成结果 -->
                <div id="generationResult" class="generation-result">
                    <h3>试卷已生成</h3>
                    <div class="result-actions">
                        <button id="downloadBtn" class="button button-primary" onclick="downloadPaper()">下载试卷(Word)</button>
                        <button id="audioDownloadBtn" class="button button-primary" onclick="downloadAudio()" style="display: none;">下载听力音频(MP3)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let allQuestions = [];
        let availableQuestionTypes = {};
        let draggedItem = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化拖拽功能
            initDragAndDrop();
            
            // 初始化题型数量变化监听
            initCountInputListeners();
            
            // 加载题目数据
            loadQuestions();
            
            // 绑定生成按钮事件
            document.getElementById('generateBtn').addEventListener('click', generatePaper);
        });
        
        // 初始化拖拽功能
        function initDragAndDrop() {
            const container = document.getElementById('questionTypesContainer');
            
            // 监听拖拽事件
            container.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('question-type-item')) {
                    draggedItem = e.target;
                    setTimeout(() => {
                        e.target.classList.add('dragging');
                    }, 0);
                }
            });
            
            container.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('question-type-item')) {
                    e.target.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (!draggedItem) return;
                
                const items = Array.from(container.querySelectorAll('.question-type-item:not(.dragging)'));
                const afterElement = getDragAfterElement(container, e.clientY);
                
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            });
        }
        
        // 获取拖拽后元素的位置
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.question-type-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // 初始化题型数量变化监听
        function initCountInputListeners() {
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('question-count-input')) {
                    updateTotalCount();
                    validateAndEnableGenerate();
                }
            });
        }
        
        // 更新总题目数量
        function updateTotalCount() {
            const inputs = document.querySelectorAll('.question-count-input');
            let total = 0;
            
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            
            const totalCountElement = document.getElementById('totalCount');
            totalCountElement.textContent = total;
            
            // 如果超过50题，高亮显示
            if (total > 50) {
                totalCountElement.style.color = '#ff4d4f';
            } else {
                totalCountElement.style.color = '';
            }
            
            return total;
        }
        
        // 验证并启用/禁用生成按钮
        function validateAndEnableGenerate() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const totalCount = updateTotalCount();
            
            const generateButton = document.getElementById('generateBtn');
            
            if (educationStage && subject && totalCount > 0 && totalCount <= 50) {
                generateButton.disabled = false;
            } else {
                generateButton.disabled = true;
            }
        }
        
        // 加载题目数据
        function loadQuestions() {
            fetch('/api/questions')
                .then(response => response.json())
                .then(data => {
                    allQuestions = data;
                    console.log(`加载了${allQuestions.length}道题目`);
                    
                    // 更新筛选器
                    updateFilters();
                    
                    // 预设高中默认值
                    document.getElementById('educationStage').value = '高中';
                    
                    // 初始化事件监听
                    initFilterEvents();
                })
                .catch(error => {
                    console.error('加载题目失败:', error);
                    showMessage('加载题目数据失败，请刷新页面重试', 'error');
                });
        }
        
        // 初始化筛选器事件
        function initFilterEvents() {
            // 添加事件监听
            document.getElementById('educationStage').addEventListener('change', function() {
                handleEducationStageChange();
                updateQuestionTypes();
                validateAndEnableGenerate();
            });
            
            document.getElementById('subject').addEventListener('change', function() {
                handleSubjectChange();
                updateQuestionTypes();
                validateAndEnableGenerate();
            });
            
            document.getElementById('chapter').addEventListener('change', function() {
                handleChapterChange();
                validateAndEnableGenerate();
            });
            
            document.getElementById('unit').addEventListener('change', function() {
                handleUnitChange();
                validateAndEnableGenerate();
            });
            
            document.getElementById('lesson').addEventListener('change', function() {
                validateAndEnableGenerate();
            });
            
            // 触发一次学段变化事件，初始化其他选择器
            handleEducationStageChange();
        }
        
        // 处理学段变化
        function handleEducationStageChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subjectSelect = document.getElementById('subject');
            
            // 重置其他选择器
            subjectSelect.innerHTML = '<option value="">选择科目</option>';
            document.getElementById('chapter').innerHTML = '<option value="">选择章节</option>';
            document.getElementById('unit').innerHTML = '<option value="">选择单元</option>';
            document.getElementById('lesson').innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            document.getElementById('chapter').disabled = true;
            document.getElementById('unit').disabled = true;
            document.getElementById('lesson').disabled = true;
            
            if (!educationStage) return;
            
            // 获取当前学段下的所有科目
            const subjects = [...new Set(
                allQuestions
                    .filter(q => q.educationStage === educationStage)
                    .map(q => q.subject)
            )].filter(Boolean).sort();
            
            // 填充科目选择器
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            
            // 启用科目选择器
            subjectSelect.disabled = false;
        }
        
        // 处理科目变化
        function handleSubjectChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapterSelect = document.getElementById('chapter');
            
            // 重置下级选择器
            chapterSelect.innerHTML = '<option value="">选择章节</option>';
            document.getElementById('unit').innerHTML = '<option value="">选择单元</option>';
            document.getElementById('lesson').innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            document.getElementById('unit').disabled = true;
            document.getElementById('lesson').disabled = true;
            
            if (!educationStage || !subject) {
                chapterSelect.disabled = true;
                return;
            }
            
            // 获取当前学段和科目下的所有章节
            const chapters = [...new Set(
                allQuestions
                    .filter(q => q.educationStage === educationStage && q.subject === subject)
                    .map(q => q.chapter)
            )].filter(Boolean).sort();
            
            // 填充章节选择器
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterSelect.appendChild(option);
            });
            
            // 启用章节选择器
            chapterSelect.disabled = false;
        }
        
        // 处理章节变化
        function handleChapterChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapter = document.getElementById('chapter').value;
            const unitSelect = document.getElementById('unit');
            
            // 重置下级选择器
            unitSelect.innerHTML = '<option value="">选择单元</option>';
            document.getElementById('lesson').innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            document.getElementById('lesson').disabled = true;
            
            if (!educationStage || !subject || !chapter) {
                unitSelect.disabled = true;
                return;
            }
            
            // 获取当前学段、科目和章节下的所有单元
            const units = [...new Set(
                allQuestions
                    .filter(q => 
                        q.educationStage === educationStage && 
                        q.subject === subject && 
                        q.chapter === chapter
                    )
                    .map(q => q.unit)
            )].filter(Boolean).sort();
            
            // 填充单元选择器
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                unitSelect.appendChild(option);
            });
            
            // 启用单元选择器
            unitSelect.disabled = false;
            
            console.log(`已加载${units.length}个单元到选择器`);
        }
        
        // 处理单元变化
        function handleUnitChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapter = document.getElementById('chapter').value;
            const unit = document.getElementById('unit').value;
            const lessonSelect = document.getElementById('lesson');
            
            // 重置课程选择器
            lessonSelect.innerHTML = '<option value="">选择课程</option>';
            
            if (!educationStage || !subject || !chapter || !unit) {
                lessonSelect.disabled = true;
                return;
            }
            
            // 获取当前学段、科目、章节和单元下的所有课程
            const lessons = [...new Set(
                allQuestions
                    .filter(q => 
                        q.educationStage === educationStage && 
                        q.subject === subject && 
                        q.chapter === chapter && 
                        q.unit === unit
                    )
                    .map(q => q.lesson)
            )].filter(Boolean).sort();
            
            // 填充课程选择器
            lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            });
            
            // 启用课程选择器
            lessonSelect.disabled = false;
            
            console.log(`已加载${lessons.length}个课程到选择器`);
        }
        
        // 更新筛选器
        function updateFilters() {
            // 调用初始化
            console.log("数据加载完成，初始化筛选器");
        }
        
        // 更新题型选择器
        function updateQuestionTypes() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            
            if (!educationStage || !subject) {
                // 如果没有选择学段或科目，显示默认题型
                document.getElementById('questionTypesContainer').innerHTML = `
                    <div class="question-type-item" data-type="单选题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">单选题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="10" data-type="单选题">
                    </div>
                    <div class="question-type-item" data-type="多选题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">多选题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="多选题">
                    </div>
                    <div class="question-type-item" data-type="判断题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">判断题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="判断题">
                    </div>
                    <div class="question-type-item" data-type="填空题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">填空题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="填空题">
                    </div>
                    <div class="question-type-item" data-type="解答题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">解答题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="解答题">
                    </div>
                `;
                return;
            }
            
            // 英语科目特殊处理
            if (subject === '英语') {
                handleEnglishSubject(educationStage);
                return;
            }
            
            // 获取该学段和科目下的所有题型
            const availableTypes = [...new Set(
                allQuestions
                    .filter(q => q.educationStage === educationStage && q.subject === subject)
                    .map(q => q.question_type)
            )].filter(Boolean);
            
            // 按照选择题、填空题、解答题等特定顺序排序
            const orderedTypes = orderQuestionTypes(availableTypes);
            
            // 生成题型选择器HTML
            const html = orderedTypes.map(type => `
                <div class="question-type-item" data-type="${type}" draggable="true">
                    <div class="type-info">
                        <span class="drag-handle">☰</span>
                        <span class="question-type-name">${type}</span>
                    </div>
                    <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="${type}">
                </div>
            `).join('');
            
            document.getElementById('questionTypesContainer').innerHTML = html;
            
            // 重新绑定拖拽事件
            initDragAndDrop();
        }
        
        // 为英语科目处理特殊题型
        function handleEnglishSubject(educationStage) {
            const container = document.getElementById('questionTypesContainer');
            
            // 获取所有英语题型
            const allEnglishTypes = [...new Set(
                allQuestions
                    .filter(q => q.educationStage === educationStage && q.subject === '英语')
                    .map(q => q.question_type)
            )].filter(Boolean);
            
            // 获取所有听力类型的章节（子类型）
            const listeningSubtypes = [...new Set(
                allQuestions
                    .filter(q => 
                        q.educationStage === educationStage && 
                        q.subject === '英语' && 
                        (q.question_type === '听力理解' || q.question_type.includes('听力'))
                    )
                    .map(q => q.chapter)
            )].filter(Boolean).sort();
            
            // 按照选择题、听力题等特定顺序排序
            const orderedTypes = orderQuestionTypes(allEnglishTypes);
            
            let html = '';
            
            // 生成题型选择器HTML
            orderedTypes.forEach(type => {
                // 特殊处理听力理解题型
                if (type === '听力理解' || type.includes('听力')) {
                    // 先添加主听力题型
                    html += `
                        <div class="question-type-group listening-group">
                            <div class="question-type-header">
                                <span class="question-type-name"><strong>${type}</strong></span>
                            </div>
                    `;
                    
                    // 添加听力子类型
                    if (listeningSubtypes.length > 0) {
                        listeningSubtypes.forEach(subtype => {
                            html += `
                                <div class="question-type-item listening-subtype" data-type="${type}" data-subtype="${subtype}" draggable="true">
                                    <div class="type-info">
                                        <span class="drag-handle">☰</span>
                                        <span class="question-type-name">${subtype}</span>
                                    </div>
                                    <input type="number" class="question-count-input" min="0" max="20" value="5" 
                                           data-type="${type}" data-subtype="${subtype}">
                                </div>
                            `;
                        });
                    } else {
                        // 如果没有子类型，就只添加主类型
                        html += `
                            <div class="question-type-item" data-type="${type}" draggable="true">
                                <div class="type-info">
                                    <span class="drag-handle">☰</span>
                                    <span class="question-type-name">${type}</span>
                                </div>
                                <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="${type}">
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                } else {
                    // 非听力题型正常处理
                    html += `
                        <div class="question-type-item" data-type="${type}" draggable="true">
                            <div class="type-info">
                                <span class="drag-handle">☰</span>
                                <span class="question-type-name">${type}</span>
                            </div>
                            <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="${type}">
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            
            // 重新绑定拖拽事件
            initDragAndDrop();
        }
        
        // 将题型按照特定顺序排序
        function orderQuestionTypes(types) {
            const typeOrder = [
                '选择题', '单选题', '多选题', 
                '听力理解', '听力', '短对话听力', '长对话听力', '短文听力',
                '阅读理解', '完形填空', 
                '填空题', '判断题', '解答题', '作文'
            ];
            
            // 按照预定义顺序排序
            const orderedTypes = [];
            
            // 先添加有序类型
            typeOrder.forEach(orderType => {
                if (types.includes(orderType)) {
                    orderedTypes.push(orderType);
                }
            });
            
            // 再添加其他类型
            types.forEach(type => {
                if (!orderedTypes.includes(type)) {
                    orderedTypes.push(type);
                }
            });
            
            return orderedTypes;
        }
        
        // 显示消息
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'message-box';
            messageBox.classList.add(type);
            messageBox.style.display = 'block';
            
            // 5秒后自动隐藏
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }
        
        // 生成试卷
        function generatePaper() {
            // 获取筛选条件
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapter = document.getElementById('chapter').value;
            const unit = document.getElementById('unit').value;
            const lesson = document.getElementById('lesson').value;
            
            // 获取用户输入的试卷名称
            const paperTitle = document.getElementById('paperTitleInput').value.trim() || "智能组卷试题";
            
            // 获取题型和数量
            const questionTypes = [];
            const typeItems = document.querySelectorAll('.question-type-item');
            
            typeItems.forEach(item => {
                const type = item.getAttribute('data-type');
                const countInput = item.querySelector('.question-count-input');
                const count = parseInt(countInput.value, 10) || 0;
                
                // 检查是否有子类型（听力题特殊处理）
                const subtype = item.getAttribute('data-subtype');
                
                if (count > 0) {
                    if (subtype) {
                        // 听力题子类型
                        questionTypes.push({
                            type: type,
                            subtype: subtype,
                            count: count
                        });
                    } else {
                        // 普通题型
                        questionTypes.push({
                            type: type,
                            count: count
                        });
                    }
                }
            });
            
            // 验证数据
            if (!educationStage || !subject) {
                showMessage('请选择学段和科目', 'error');
                return;
            }
            
            if (questionTypes.length === 0) {
                showMessage('请至少选择一种题型', 'error');
                return;
            }
            
            // 显示加载中提示
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            
            // 准备发送数据
            const requestData = {
                educationStage,
                subject,
                chapter,
                unit,
                lesson,
                questionTypes,
                paperTitle
            };
            
            // 发送请求
            fetch('/api/generate_smart_paper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
                
                if (data.error) {
                    showMessage(data.error, 'error');
                    return;
                }
                
                if (data.success) {
                    // 显示成功消息
                    showMessage('试卷生成成功', 'success');
                    
                    // 保存生成的ID和试卷标题，用于生成试卷
                    window.generatedPaperData = {
                        question_ids: data.question_ids,
                        paper_title: data.paper_title,
                        has_audio: data.has_audio // 是否包含音频文件
                    };
                    
                    // 显示下载选项
                    document.getElementById('generationResult').style.display = 'block';
                    
                    // 如果是英语听力，添加音频下载按钮
                    const hasAudio = data.has_audio || (subject === "英语" && questionTypes.some(t => 
                        t.type.includes("听力") || t.subtype?.includes("听力")));
                    
                    const audioDownloadBtn = document.getElementById('audioDownloadBtn');
                    if (hasAudio) {
                        audioDownloadBtn.style.display = 'inline-block';
                    } else {
                        audioDownloadBtn.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
                showMessage('服务器错误，请稍后重试', 'error');
                console.error('Error:', error);
            });
        }
        
        // 下载试卷
        function downloadPaper() {
            if (!window.generatedPaperData) {
                showMessage('请先生成试卷', 'error');
                return;
            }
            
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            
            fetch('/generate_paper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(window.generatedPaperData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('downloadBtn').disabled = false;
                
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.generatedPaperData.paper_title + '.docx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('downloadBtn').disabled = false;
                showMessage('下载失败，请重试', 'error');
                console.error('Download error:', error);
            });
        }
        
        // 下载音频
        function downloadAudio() {
            if (!window.generatedPaperData) {
                showMessage('请先生成试卷', 'error');
                return;
            }
            
            document.getElementById('audioDownloadBtn').disabled = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            
            fetch('/generate_paper_audio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(window.generatedPaperData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('audioDownloadBtn').disabled = false;
                
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.generatedPaperData.paper_title + '_听力.mp3';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('audioDownloadBtn').disabled = false;
                showMessage('音频下载失败，请重试', 'error');
                console.error('Audio download error:', error);
            });
        }
    </script>
</body>
</html>
