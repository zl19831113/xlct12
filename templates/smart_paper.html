<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小鹿题库系统 - 智能组卷</title>
    <link rel="stylesheet" href="/static/css/header.css">
    <style>
        :root {
            --primary-color: #2F80ED;
            --secondary-color: #E6F0FF;
            --background-main: #FFFFFF;
            --background-subtle: #F9FAFB;
            --text-main: #333333;
            --text-heading: #000000;
            --text-subheading: #444444;
            --border-color: #E0E0E0;
            --box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --border-radius: 6px;
            --padding: 16px;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }

        .main-container {
            display: flex;
            gap: 16px;
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 16px 16px 16px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* 默认样式（移动端） */
        .content-area {
            width: 100%;
        }
        
        /* 只在标准或大屏幕设备上有内边距 */
        @media (min-width: 992px) {
            .content-area {
                margin-left: 300px; /* 留出筛选栏的空间 */
                width: calc(100% - 300px);
            }
        }
        
        /* 左侧筛选侧边栏样式 */
        .filter-sidebar {
            width: 280px;
            flex-shrink: 0;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        /* 只在标准或大屏幕设备上有固定底部定位 */
        @media (min-width: 992px) {
            .filter-sidebar {
                position: fixed;
                left: max(calc((100% - 1200px) / 2 + 16px), 16px);
                top: 150px; /* 从100px调整到150px，让筛选栏下移 */
                max-height: calc(100vh - 170px);
                z-index: 100;
            }
        }

        .filter-box {
            background-color: var(--background-main);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .filter-box-content {
            padding: var(--padding);
        }

        .filter-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-item:last-child {
            border-bottom: none;
        }

        .filter-item label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-subheading);
            font-size: 14px;
            font-weight: 500;
        }

        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            background-image: linear-gradient(to bottom, #ffffff, #f8f9fa);
        }

        select:hover {
            border-color: var(--primary-color);
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(47, 128, 237, 0.2);
        }

        select:disabled {
            background-color: var(--background-subtle);
            cursor: not-allowed;
            color: rgba(0, 0, 0, 0.25);
        }
        
        /* 题型选择部分样式 */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* 试卷标题输入框样式 */
        .paper-title-input-container {
            margin-bottom: 20px;
            padding: 12px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .paper-title-input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-subheading);
        }
        
        .paper-title-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        /* 题型选择样式 */
        .question-types-container {
            margin-bottom: 30px;
        }
        
        .question-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 10px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            cursor: move;
        }
        
        /* 听力题型分组样式 */
        .question-type-group {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .question-type-group-title {
            font-size: 16px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .question-type-group .question-type-item {
            margin-left: 10px;
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        .question-type-item.dragging {
            opacity: 0.5;
        }
        
        .type-info {
            display: flex;
            align-items: center;
        }
        
        .drag-handle {
            margin-right: 10px;
            color: var(--text-secondary);
            cursor: grab;
        }
        
        .question-type-name {
            font-weight: 500;
        }
        
        .question-count-input {
            width: 60px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .generate-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }
        
        .generate-button:hover {
            background-color: #1C66B3;
        }
        
        .generate-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .required-mark {
            color: #ff4d4f;
            margin-left: 2px;
        }
        
        /* 进度显示 */
        .progress-container {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 消息提示样式 */
        .message-box {
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
        }
        
        .message-box.error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        
        .message-box.success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
    </style>
</head>
<body>
    <!-- 引入公共头部组件 -->
    {% include 'header.html' %}

    <div class="main-container">
        <div class="filter-sidebar">
            <div class="filter-box">
                <div class="filter-box-content">
                    <div class="filter-item">
                        <label for="educationStage">学段 <span class="required-mark">*</span></label>
                        <select id="educationStage" onchange="handleFilterChange(event)">
                            <option value="">选择学段</option>
                            <option value="小学">小学</option>
                            <option value="初中">初中</option>
                            <option value="高中" selected>高中</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="subject">科目 <span class="required-mark">*</span></label>
                        <select id="subject" onchange="updateQuestionTypes()">
                            <option value="">选择科目</option>
                            <option value="语文">语文</option>
                            <option value="数学">数学</option>
                            <option value="英语">英语</option>
                            <option value="物理">物理</option>
                            <option value="化学">化学</option>
                            <option value="生物">生物</option>
                            <option value="政治">政治</option>
                            <option value="历史">历史</option>
                            <option value="地理">地理</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="chapter">章节</label>
                        <select id="chapter" disabled>
                            <option value="">选择章节</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="unit">单元</label>
                        <select id="unit" disabled>
                            <option value="">选择单元</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="lesson">课程</label>
                        <select id="lesson" disabled>
                            <option value="">选择课程</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content-area">
            <!-- 消息提示框 -->
            <div id="messageBox" class="message-box"></div>
            
            <!-- 题型选择部分 -->
            <div class="question-types-container">
                <h2 class="section-title">题型和题目数量选择</h2>
                <p>请选择您需要的题型和数量，拖动可调整题型顺序。总题目数量不超过50题。</p>
                
                <!-- 添加试卷名称输入框 -->
                <div class="paper-title-input-container">
                    <label for="paperTitleInput">试卷名称</label>
                    <input type="text" id="paperTitleInput" class="paper-title-input" placeholder="请输入试卷名称" value="智能组卷试题">
                </div>
                
                <div id="questionTypesContainer">
                    <!-- 题型列表将通过JavaScript动态生成 -->
                    <div class="question-type-item" data-type="单选题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">单选题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="10" data-type="单选题">
                    </div>
                </div>
                
                <div class="total-count">
                    已选择: <span id="totalCount">0</span> / 50 题
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="action-buttons-container">
                <button id="generateButton" class="btn btn-primary" onclick="generatePaper()" disabled>
                    <i class="fas fa-file-word"></i> 生成试卷
                </button>
            </div>
            
            <!-- 进度指示器 -->
            <div id="progressContainer" class="progress-container" style="display: none;">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
                <p id="progressMessage" class="progress-message">处理中，请稍候...</p>
            </div>
            
            <!-- 消息提示 -->
            <div id="alertMessage" class="alert" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 全局变量
        let allQuestions = [];
        let availableQuestionTypes = {};
        let draggedItem = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化拖拽功能
            initDragAndDrop();
            
            // 初始化题型数量变化监听
            initCountInputListeners();
            
            // 加载题目数据
            loadQuestions();
            
            // 绑定生成按钮事件
            document.getElementById('generateButton').addEventListener('click', generatePaper);
        });
        
        // 初始化拖拽功能
        function initDragAndDrop() {
            const container = document.getElementById('questionTypesContainer');
            
            // 监听拖拽事件
            container.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('question-type-item')) {
                    draggedItem = e.target;
                    setTimeout(() => {
                        e.target.classList.add('dragging');
                    }, 0);
                }
            });
            
            container.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('question-type-item')) {
                    e.target.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (!draggedItem) return;
                
                const items = Array.from(container.querySelectorAll('.question-type-item:not(.dragging)'));
                const afterElement = getDragAfterElement(container, e.clientY);
                
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            });
        }
        
        // 获取拖拽后元素的位置
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.question-type-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // 初始化题型数量变化监听
        function initCountInputListeners() {
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('question-count-input')) {
                    updateTotalCount();
                    validateAndEnableGenerate();
                }
            });
        }
        
        // 更新总题目数量
        function updateTotalCount() {
            const inputs = document.querySelectorAll('.question-count-input');
            let total = 0;
            
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            
            const totalCountElement = document.getElementById('totalCount');
            totalCountElement.textContent = total;
            
            // 如果超过50题，高亮显示
            if (total > 50) {
                totalCountElement.style.color = '#ff4d4f';
            } else {
                totalCountElement.style.color = '';
            }
            
            return total;
        }
        
        // 验证并启用/禁用生成按钮
        function validateAndEnableGenerate() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const totalCount = updateTotalCount();
            
            const generateButton = document.getElementById('generateButton');
            
            if (educationStage && subject && totalCount > 0 && totalCount <= 50) {
                generateButton.disabled = false;
            } else {
                generateButton.disabled = true;
            }
        }
        
        // 加载题目数据
        function loadQuestions() {
            fetch('/api/questions')
                .then(response => response.json())
                .then(data => {
                    allQuestions = data;
                    console.log(`加载了${allQuestions.length}道题目`);
                    
                    // 更新筛选器
                    updateFilters();
                    
                    // 预设高中默认值
                    document.getElementById('educationStage').value = '高中';
                    
                    // 初始化事件监听
                    initFilterEvents();
                })
                .catch(error => {
                    console.error('加载题目失败:', error);
                    showMessage('加载题目数据失败，请刷新页面重试', 'error');
                });
        }
        
        // 初始化筛选器事件
        function initFilterEvents() {
            // 添加事件监听
            document.getElementById('educationStage').addEventListener('change', function() {
                handleEducationStageChange();
                updateQuestionTypes();
                validateAndEnableGenerate();
            });
            
            document.getElementById('subject').addEventListener('change', function() {
                handleSubjectChange();
                updateQuestionTypes();
                validateAndEnableGenerate();
            });
            
            document.getElementById('chapter').addEventListener('change', function() {
                handleChapterChange();
                validateAndEnableGenerate();
            });
            
            document.getElementById('unit').addEventListener('change', function() {
                handleUnitChange();
                validateAndEnableGenerate();
            });
            
            document.getElementById('lesson').addEventListener('change', function() {
                validateAndEnableGenerate();
            });
            
            // 触发一次学段变化事件，初始化其他选择器
            handleEducationStageChange();
        }
        
        // 处理学段变化
        function handleEducationStageChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subjectSelect = document.getElementById('subject');
            
            // 重置其他选择器
            subjectSelect.innerHTML = '<option value="">选择科目</option>';
            document.getElementById('chapter').innerHTML = '<option value="">选择章节</option>';
            document.getElementById('unit').innerHTML = '<option value="">选择单元</option>';
            document.getElementById('lesson').innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            document.getElementById('chapter').disabled = true;
            document.getElementById('unit').disabled = true;
            document.getElementById('lesson').disabled = true;
            
            if (!educationStage) return;
            
            // 获取当前学段下的所有科目
            const subjects = [...new Set(
                allQuestions
                    .filter(q => q.educationStage === educationStage)
                    .map(q => q.subject)
            )].filter(Boolean).sort();
            
            // 填充科目选择器
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            
            // 启用科目选择器
            subjectSelect.disabled = false;
        }
        
        // 处理科目变化
        function handleSubjectChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapterSelect = document.getElementById('chapter');
            
            // 重置下级选择器
            chapterSelect.innerHTML = '<option value="">选择章节</option>';
            document.getElementById('unit').innerHTML = '<option value="">选择单元</option>';
            document.getElementById('lesson').innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            document.getElementById('unit').disabled = true;
            document.getElementById('lesson').disabled = true;
            
            if (!educationStage || !subject) {
                chapterSelect.disabled = true;
                return;
            }
            
            // 获取当前学段和科目下的所有章节
            const chapters = [...new Set(
                allQuestions
                    .filter(q => q.educationStage === educationStage && q.subject === subject)
                    .map(q => q.chapter)
            )].filter(Boolean).sort();
            
            // 填充章节选择器
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterSelect.appendChild(option);
            });
            
            // 启用章节选择器
            chapterSelect.disabled = false;
        }
        
        // 处理章节变化
        function handleChapterChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapter = document.getElementById('chapter').value;
            const unitSelect = document.getElementById('unit');
            
            // 重置下级选择器
            unitSelect.innerHTML = '<option value="">选择单元</option>';
            document.getElementById('lesson').innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            document.getElementById('lesson').disabled = true;
            
            if (!educationStage || !subject || !chapter) {
                unitSelect.disabled = true;
                return;
            }
            
            // 获取当前学段、科目和章节下的所有单元
            const units = [...new Set(
                allQuestions
                    .filter(q => 
                        q.educationStage === educationStage && 
                        q.subject === subject && 
                        q.chapter === chapter
                    )
                    .map(q => q.unit)
            )].filter(Boolean).sort();
            
            // 填充单元选择器
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                unitSelect.appendChild(option);
            });
            
            // 启用单元选择器
            unitSelect.disabled = false;
            
            console.log(`已加载${units.length}个单元到选择器`);
        }
        
        // 处理单元变化
        function handleUnitChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapter = document.getElementById('chapter').value;
            const unit = document.getElementById('unit').value;
            const lessonSelect = document.getElementById('lesson');
            
            // 重置课程选择器
            lessonSelect.innerHTML = '<option value="">选择课程</option>';
            
            if (!educationStage || !subject || !chapter || !unit) {
                lessonSelect.disabled = true;
                return;
            }
            
            // 获取当前学段、科目、章节和单元下的所有课程
            const lessons = [...new Set(
                allQuestions
                    .filter(q => 
                        q.educationStage === educationStage && 
                        q.subject === subject && 
                        q.chapter === chapter && 
                        q.unit === unit
                    )
                    .map(q => q.lesson)
            )].filter(Boolean).sort();
            
            // 填充课程选择器
            lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            });
            
            // 启用课程选择器
            lessonSelect.disabled = false;
            
            console.log(`已加载${lessons.length}个课程到选择器`);
        }
        
        // 更新筛选器
        function updateFilters() {
            // 调用初始化
            console.log("数据加载完成，初始化筛选器");
        }
        
        // 更新题型选择器
        function updateQuestionTypes() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            
            if (!educationStage || !subject) {
                // 如果没有选择学段或科目，显示默认题型
                document.getElementById('questionTypesContainer').innerHTML = `
                    <div class="question-type-item" data-type="单选题" draggable="true">
                        <div class="type-info">
                            <span class="drag-handle">☰</span>
                            <span class="question-type-name">单选题</span>
                        </div>
                        <input type="number" class="question-count-input" min="0" max="20" value="10" data-type="单选题">
                    </div>
                `;
                setupDragAndDrop();
                return;
            }
            
            // 获取该学段和科目下的所有题型
            const types = [...new Set(
                allQuestions
                    .filter(q => q.educationStage === educationStage && q.subject === subject)
                    .map(q => q.question_type)
            )].filter(Boolean);
            
            // 优先排序，选择题类型始终在最前面
            const orderedTypes = [];
            // 先添加选择题类型
            ['单选题', '多选题', '选择题'].forEach(type => {
                if (types.includes(type)) {
                    orderedTypes.push(type);
                }
            });
            // 再添加其他类型
            types.forEach(type => {
                if (!orderedTypes.includes(type)) {
                    orderedTypes.push(type);
                }
            });
            
            let html = '';
            
            // 对于英语科目的听力题型特殊处理
            const isEnglishSubject = subject === '英语';
            const hasListeningType = isEnglishSubject && orderedTypes.includes('听力理解题');
            
            // 如果是英语学科并且有听力题型，创建听力分类选择器
            if (hasListeningType) {
                // 获取听力题目的章节分类
                const listeningChapters = [...new Set(
                    allQuestions
                        .filter(q => 
                            q.educationStage === educationStage && 
                            q.subject === subject && 
                            q.question_type === '听力理解题'
                        )
                        .map(q => q.chapter)
                )].filter(Boolean).sort();
                
                // 先添加非听力题型
                orderedTypes.forEach(type => {
                    if (type !== '听力理解题') {
                        html += `
                            <div class="question-type-item" data-type="${type}" draggable="true">
                                <div class="type-info">
                                    <span class="drag-handle">☰</span>
                                    <span class="question-type-name">${type}</span>
                                </div>
                                <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="${type}">
                            </div>
                        `;
                    }
                });
                
                // 添加听力理解题分类选项
                html += `
                    <div class="question-type-group">
                        <h3 class="question-type-group-title">听力理解题</h3>
                `;
                
                // 添加每个听力章节作为子类型
                listeningChapters.forEach(chapter => {
                    const typeId = `听力_${chapter}`;
                    html += `
                        <div class="question-type-item" data-type="${typeId}" draggable="true">
                            <div class="type-info">
                                <span class="drag-handle">☰</span>
                                <span class="question-type-name">${chapter}</span>
                            </div>
                            <input type="number" class="question-count-input" min="0" max="10" value="3" data-type="${typeId}">
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                // 普通科目正常显示题型
                orderedTypes.forEach(type => {
                    html += `
                        <div class="question-type-item" data-type="${type}" draggable="true">
                            <div class="type-info">
                                <span class="drag-handle">☰</span>
                                <span class="question-type-name">${type}</span>
                            </div>
                            <input type="number" class="question-count-input" min="0" max="20" value="5" data-type="${type}">
                        </div>
                    `;
                });
            }
            
            document.getElementById('questionTypesContainer').innerHTML = html;
            setupDragAndDrop();
        }
        
        // 显示消息
        function showMessage(message, type = 'info') {
            const alertElement = document.getElementById('alertMessage');
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 3000);
        }
        
        // 显示加载提示
        function showLoading(message = '处理中，请稍候...') {
            const progressContainer = document.getElementById('progressContainer');
            const progressMessage = document.getElementById('progressMessage');
            if (progressMessage) {
                progressMessage.textContent = message;
            }
            progressContainer.style.display = 'block';
            
            // 禁用生成按钮
            document.getElementById('generateButton').disabled = true;
        }
        
        // 隐藏加载提示
        function hideLoading() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'none';
            
            // 启用生成按钮
            document.getElementById('generateButton').disabled = false;
        }
        
        // 设置拖拽功能
        function setupDragAndDrop() {
            const items = document.querySelectorAll('.question-type-item');
            let draggedItem = null;
            
            items.forEach(item => {
                // 监听拖拽开始事件
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    setTimeout(() => {
                        this.classList.add('dragging');
                    }, 0);
                });
                
                // 监听拖拽结束事件
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedItem = null;
                });
                
                // 监听拖拽经过事件
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                // 监听放置事件
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (draggedItem && draggedItem !== this) {
                        // 获取拖拽项和目标项的父元素
                        const draggedParent = draggedItem.parentNode;
                        const targetParent = this.parentNode;
                        
                        // 如果是同一个父元素内的排序
                        if (draggedParent === targetParent) {
                            const container = draggedParent;
                            const children = Array.from(container.children);
                            const draggedIndex = children.indexOf(draggedItem);
                            const targetIndex = children.indexOf(this);
                            
                            if (draggedIndex < targetIndex) {
                                container.insertBefore(draggedItem, this.nextSibling);
                            } else {
                                container.insertBefore(draggedItem, this);
                            }
                        }
                    }
                });
            });
        }
        
        // 生成试卷
        function generatePaper() {
            // 获取筛选条件
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const chapter = document.getElementById('chapter').value;
            const unit = document.getElementById('unit').value;
            const lesson = document.getElementById('lesson').value;
            
            // 获取用户输入的试卷名称
            const paperTitle = document.getElementById('paperTitleInput').value.trim() || "智能组卷试题";
            
            // 获取题型和数量
            const questionTypes = [];
            const typeItems = document.querySelectorAll('.question-type-item');
            
            typeItems.forEach(item => {
                const type = item.getAttribute('data-type');
                const input = item.querySelector('.question-count-input');
                const count = parseInt(input.value, 10) || 0;
                
                if (count > 0) {
                    // 检查是否是听力子类型
                    if (type.startsWith('听力_')) {
                        const chapter = type.replace('听力_', '');
                        questionTypes.push({
                            type: '听力理解题',
                            count: count,
                            chapter: chapter  // 添加章节信息
                        });
                    } else {
                        questionTypes.push({
                            type: type,
                            count: count
                        });
                    }
                }
            });
            
            if (questionTypes.length === 0) {
                showMessage('请至少选择一种题型并设置数量', 'error');
                return;
            }
            
            // 显示加载进度
            showLoading('正在生成试卷，请稍候...');
            
            // 发送请求到后端
            fetch('/api/generate_smart_paper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    educationStage: educationStage,
                    subject: subject,
                    chapter: chapter,
                    unit: unit,
                    lesson: lesson,
                    questionTypes: questionTypes,
                    paperTitle: paperTitle
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.error) {
                    showMessage(data.error, 'error');
                    return;
                }
                
                // 生成试卷成功
                showMessage('试卷生成成功！', 'success');
                
                // 使用题目ID生成试卷Word文档
                generateWord(data.question_ids, data.paper_title);
                
                // 对于英语听力，检查是否需要下载MP3
                const isEnglishSubject = subject === '英语';
                const hasListeningType = questionTypes.some(q => q.type === '听力理解题');
                
                if (isEnglishSubject && hasListeningType && data.has_audio) {
                    // 显示MP3下载按钮
                    showMP3DownloadButton(data.audio_id);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('生成试卷失败:', error);
                showMessage('生成试卷失败，请重试', 'error');
            });
        }
        
        // 生成Word文档
        function generateWord(questionIds, paperTitle) {
            showLoading('正在生成Word文档，请稍候...');
            
            fetch('/generate_paper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question_ids: questionIds,
                    paper_title: paperTitle
                })
            })
            .then(response => {
                hideLoading();
                
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('生成Word文档失败');
                }
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${paperTitle}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('下载Word文档失败:', error);
                showMessage('下载Word文档失败，请重试', 'error');
            });
        }
        
        // 显示MP3下载按钮
        function showMP3DownloadButton(audioId) {
            // 创建MP3下载按钮
            const container = document.querySelector('.action-buttons-container');
            
            // 检查是否已有MP3下载按钮
            const existingButton = document.getElementById('downloadMp3Button');
            if (existingButton) {
                existingButton.remove();
            }
            
            const mp3Button = document.createElement('button');
            mp3Button.id = 'downloadMp3Button';
            mp3Button.className = 'btn btn-secondary';
            mp3Button.innerHTML = '<i class="fas fa-music"></i> 下载听力MP3';
            mp3Button.onclick = function() {
                downloadMP3Audio(audioId);
            };
            
            container.appendChild(mp3Button);
        }
        
        // 下载MP3文件
        function downloadMP3Audio(audioId) {
            showLoading('正在生成听力MP3文件，请稍候...');
            
            fetch(`/download_audio/${audioId}`)
            .then(response => {
                hideLoading();
                
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('下载MP3文件失败');
                }
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '听力音频.mp3';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage('听力MP3下载成功！', 'success');
            })
            .catch(error => {
                console.error('下载MP3文件失败:', error);
                showMessage('下载MP3文件失败，请重试', 'error');
            });
        }
    </script>
</body>
</html>
