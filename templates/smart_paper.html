<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小鹿题库系统 - 智能组卷</title>
    <link rel="stylesheet" href="/static/css/header.css">
    <style>
        body {
            font-family: "Microsoft YaHei", "Hiragino Sans GB", "WenQuanYi Micro Hei", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eaeaea;
            padding-bottom: 15px;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
            vertical-align: middle;
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            gap: 30px;
        }
        
        .sidebar {
            flex: 0 0 300px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            height: fit-content;
        }
        
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #4a5568;
        }
        
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filter-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #4a5568;
        }
        
        .main-content {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }
        
        .section-title {
            font-size: 20px;
            margin: 0 0 20px 0;
            color: #2c3e50;
        }
        
        .paper-title-section {
            margin-bottom: 20px;
        }
        
        #paperTitleInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .question-types-section {
            margin-bottom: 20px;
        }
        
        .question-type-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .question-type-item {
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .question-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-type-name {
            font-weight: bold;
        }
        
        .question-count-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .listening-subtypes {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        .listening-subtype-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background-color: #3490dc;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #2779bd;
        }
        
        .btn-primary:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        
        .buttons-section {
            margin-top: 20px;
            text-align: center;
        }
        
        .progress-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        
        .progress-message {
            margin-top: 10px;
            font-style: italic;
            color: #718096;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3490dc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .message {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: fadein 0.5s;
        }
        
        .success {
            background-color: #48bb78;
            color: white;
        }
        
        .error {
            background-color: #f56565;
            color: white;
        }
        
        @keyframes fadein {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .sidebar {
                flex: none;
                width: 100%;
                margin-bottom: 20px;
            }
            
            .question-type-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 引入公共头部组件 -->
    {% include 'header.html' %}

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">智能组卷系统</h1>
            <p>根据需要选择学段、科目和题型，自动生成高质量的试卷</p>
        </div>
        
        <div class="content-wrapper">
            <div class="sidebar">
                <h2 class="section-title">筛选条件</h2>
                
                <div class="filter-group">
                    <label for="educationStage">学段:</label>
                    <select id="educationStage">
                        <option value="">选择学段</option>
                        <option value="小学">小学</option>
                        <option value="初中">初中</option>
                        <option value="高中">高中</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="subject">科目:</label>
                    <select id="subject" disabled>
                        <option value="">选择科目</option>
                    </select>
                </div>
                
                <div class="filter-group chapter-filter">
                    <label class="filter-label">章节</label>
                </div>
                
                <div class="filter-group">
                    <label for="unit">单元:</label>
                    <select id="unit" disabled>
                        <option value="">选择单元</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="lesson">课程:</label>
                    <select id="lesson" disabled>
                        <option value="">选择课程</option>
                    </select>
                </div>
            </div>
            
            <div class="main-content">
                <!-- 消息提示框 -->
                <div id="messageBox" class="message-box"></div>
                
                <!-- 题型选择部分 -->
                <div class="question-types-section">
                    <h2 class="section-title">题型和题目数量选择</h2>
                    <p>请选择您需要的题型和数量，拖动可调整题型顺序。总题目数量不超过50题。</p>
                    
                    <!-- 添加试卷名称输入框 -->
                    <div class="paper-title-section">
                        <label for="paperTitleInput">试卷名称</label>
                        <input type="text" id="paperTitleInput" class="paper-title-input" placeholder="请输入试卷名称" value="智能组卷试题">
                    </div>
                    
                    <div id="questionTypesContainer">
                        <!-- 题型列表将通过JavaScript动态生成 -->
                        <div id="questionTypesList"></div>
                    </div>
                    
                    <div class="total-count" id="totalCountContainer">
                        已选择: <span id="totalCount">0</span> / 50 题
                    </div>
                </div>
                
                <!-- 生成按钮部分 -->
                <button id="generateButton" class="generate-button" disabled>智能组卷</button>
                
                <!-- 加载进度显示 -->
                <div id="progressContainer" class="progress-container">
                    <div class="spinner"></div>
                    <p>正在生成试卷，请稍候...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let questionTypes = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            // 获取所有题目数据
            fetch('/api/questions')
                .then(response => response.json())
                .then(data => {
                    allQuestions = data;
                    console.log(`加载了 ${allQuestions.length} 道题目`);
                    
                    // 启用学段选择器
                    document.getElementById('educationStage').disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                    showMessage('加载题目失败，请刷新页面重试', 'error');
                });
            
            // 添加事件监听器
            document.getElementById('educationStage').addEventListener('change', handleEducationStageChange);
            document.getElementById('subject').addEventListener('change', handleSubjectChange);
            document.getElementById('unit').addEventListener('change', handleUnitChange);
            document.getElementById('lesson').addEventListener('change', handleLessonChange);
            document.getElementById('generateButton').addEventListener('click', generatePaper);
        });
        
        // 处理学段变化
        function handleEducationStageChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subjectSelect = document.getElementById('subject');
            
            // 重置下级选择器
            subjectSelect.innerHTML = '<option value="">选择科目</option>';
            document.getElementById('unit').innerHTML = '<option value="">选择单元</option>';
            document.getElementById('lesson').innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            subjectSelect.disabled = true;
            document.getElementById('unit').disabled = true;
            document.getElementById('lesson').disabled = true;
            
            // 清空题型列表
            document.getElementById('questionTypesList').innerHTML = '';
            
            if (educationStage) {
                // 获取该学段下的科目
                const subjects = [...new Set(allQuestions
                    .filter(q => q.education_stage === educationStage)
                    .map(q => q.subject))];
                
                // 填充科目选择器
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
                
                // 启用科目选择器
                subjectSelect.disabled = false;
            }
            
            // 更新过滤后的题目
            updateFilteredQuestions();
        }
        
        // 处理科目变化
        function handleSubjectChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const unitSelect = document.getElementById('unit');
            const lessonSelect = document.getElementById('lesson');
            
            // 重置下级选择器
            unitSelect.innerHTML = '<option value="">选择单元</option>';
            lessonSelect.innerHTML = '<option value="">选择课程</option>';
            
            // 禁用下级选择器
            unitSelect.disabled = true;
            lessonSelect.disabled = true;
            
            // 清空题型列表
            document.getElementById('questionTypesList').innerHTML = '';
            
            if (educationStage && subject) {
                // 启用单元选择器
                unitSelect.disabled = false;
                
                // 获取当前学段和科目下的所有单元
                const units = [...new Set(allQuestions
                    .filter(q => q.education_stage === educationStage && q.subject === subject)
                    .map(q => q.unit)
                    .filter(Boolean))]; // 过滤掉null和undefined
                
                // 填充单元选择器
                units.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitSelect.appendChild(option);
                });
                
                // 获取当前学段和科目下的所有题型
                const types = [...new Set(allQuestions
                    .filter(q => q.education_stage === educationStage && q.subject === subject)
                    .map(q => q.question_type))];
                
                // 填充题型列表
                populateQuestionTypes(types, subject);
            }
            
            // 更新过滤后的题目
            updateFilteredQuestions();
        }
        
        // 处理单元变化
        function handleUnitChange() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const unit = document.getElementById('unit').value;
            const lessonSelect = document.getElementById('lesson');
            
            // 重置课程选择器
            lessonSelect.innerHTML = '<option value="">选择课程</option>';
            
            if (unit) {
                // 启用课程选择器
                lessonSelect.disabled = false;
                
                // 获取当前学段、科目和单元下的所有课程
                const lessons = [...new Set(allQuestions
                    .filter(q => 
                        q.education_stage === educationStage && 
                        q.subject === subject && 
                        q.unit === unit)
                    .map(q => q.lesson)
                    .filter(Boolean))]; // 过滤掉null和undefined
                
                // 填充课程选择器
                lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson;
                    option.textContent = lesson;
                    lessonSelect.appendChild(option);
                });
            } else {
                // 禁用课程选择器
                lessonSelect.disabled = true;
            }
            
            // 选择单元不更新过滤后的题目，保持选题数量不变
        }
        
        // 处理课程变化
        function handleLessonChange() {
            // 不执行任何过滤操作，保持选题数量不变
        }
        
        // 更新过滤后的题目
        function updateFilteredQuestions() {
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const questionTypes = Array.from(document.querySelectorAll('#questionTypesList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            // 仅基于学段、科目和题型过滤问题，忽略单元和课程
            filteredQuestions = allQuestions.filter(q => 
                (!educationStage || q.education_stage === educationStage) &&
                (!subject || q.subject === subject) &&
                (questionTypes.length === 0 || questionTypes.includes(q.question_type))
            );
            
            // 更新UI显示
            updateQuestionCount();
        }
        
        // 填充题型列表
        function populateQuestionTypes(types, subject) {
            const typesList = document.getElementById('questionTypesList');
            typesList.innerHTML = '';
            
            types.forEach(type => {
                // 计算该题型的总题目数
                const count = filteredQuestions.filter(q => q.question_type === type).length;
                
                // 创建题型项
                const typeItem = document.createElement('div');
                typeItem.className = 'question-type-item';
                
                // 创建题型内容
                const isListeningType = subject === '英语' && type === '听力';
                
                if (isListeningType) {
                    // 处理英语听力题型
                    const listeningHeaderHtml = `
                        <div class="question-type-header">
                            <span class="question-type-name">${type} (共${count}题)</span>
                            <input type="number" min="0" max="${count}" value="0" class="question-count-input" data-type="${type}">
                        </div>`;
                    
                    typeItem.innerHTML = listeningHeaderHtml;
                    
                    // 添加听力子题型
                    const subtypesDiv = document.createElement('div');
                    subtypesDiv.className = 'listening-subtypes';
                    
                    // 获取所有听力子题型
                    const listeningSubtypes = [...new Set(filteredQuestions
                        .filter(q => q.question_type === '听力')
                        .map(q => q.chapter))];
                    
                    listeningSubtypes.forEach(subtype => {
                        const subtypeCount = filteredQuestions.filter(q => 
                            q.question_type === '听力' && q.chapter === subtype
                        ).length;
                        
                        const subtypeItem = document.createElement('div');
                        subtypeItem.className = 'listening-subtype-item';
                        subtypeItem.innerHTML = `
                            <span>${subtype} (共${subtypeCount}题)</span>
                            <input type="number" min="0" max="${subtypeCount}" value="0" class="question-count-input" data-type="听力" data-subtype="${subtype}">
                        `;
                        
                        subtypesDiv.appendChild(subtypeItem);
                    });
                    
                    typeItem.appendChild(subtypesDiv);
                } else {
                    // 处理其他题型
                    typeItem.innerHTML = `
                        <div class="question-type-header">
                            <span class="question-type-name">${type} (共${count}题)</span>
                            <input type="number" min="0" max="${count}" value="0" class="question-count-input" data-type="${type}">
                        </div>
                    `;
                }
                
                // 添加到题型列表
                typesList.appendChild(typeItem);
            });
            
            // 添加输入框事件监听器
            document.querySelectorAll('.question-count-input').forEach(input => {
                input.addEventListener('change', updateTotalCount);
            });
        }
        
        // 更新总题目数
        function updateTotalCount() {
            let total = 0;
            let subtypeTotal = 0;
            
            // 获取所有普通题型输入框
            const regularInputs = document.querySelectorAll('.question-count-input:not([data-subtype])');
            regularInputs.forEach(input => {
                const count = parseInt(input.value) || 0;
                const type = input.getAttribute('data-type');
                
                // 如果是听力，不计入总数(使用子题型的和)
                if (type !== '听力') {
                    total += count;
                }
            });
            
            // 获取所有听力子题型输入框
            const subtypeInputs = document.querySelectorAll('.question-count-input[data-subtype]');
            subtypeInputs.forEach(input => {
                const count = parseInt(input.value) || 0;
                subtypeTotal += count;
            });
            
            // 将听力子题型总数添加到总数中
            total += subtypeTotal;
            
            // 更新总数显示
            document.getElementById('totalCount').textContent = total;
            
            // 如果总数超过50或没有选题，禁用生成按钮
            const generateButton = document.getElementById('generateButton');
            generateButton.disabled = total === 0 || total > 50;
        }
        
        // 生成试卷
        function generatePaper() {
            // 获取学段和科目
            const educationStage = document.getElementById('educationStage').value;
            const subject = document.getElementById('subject').value;
            const paperTitle = document.getElementById('paperTitleInput').value || '智能组卷试题';
            
            // 验证必填字段
            if (!educationStage || !subject) {
                showMessage('请选择学段和科目', 'error');
                return;
            }
            
            // 收集题型和数量
            const questionTypes = [];
            let hasSelectedQuestions = false;
            
            // 处理普通题型
            document.querySelectorAll('.question-count-input:not([data-subtype])').forEach(input => {
                const type = input.getAttribute('data-type');
                const count = parseInt(input.value) || 0;
                
                if (count > 0 && type !== '听力') {
                    questionTypes.push({
                        type: type,
                        count: count
                    });
                    hasSelectedQuestions = true;
                }
            });
            
            // 处理听力子题型
            const listeningSubtypes = [];
            document.querySelectorAll('.question-count-input[data-subtype]').forEach(input => {
                const subtype = input.getAttribute('data-subtype');
                const count = parseInt(input.value) || 0;
                
                if (count > 0) {
                    listeningSubtypes.push({
                        subtype: subtype,
                        count: count
                    });
                    hasSelectedQuestions = true;
                }
            });
            
            // 如果有听力子题型，添加到题型列表
            if (listeningSubtypes.length > 0) {
                questionTypes.push({
                    type: '听力',
                    subtypes: listeningSubtypes
                });
            }
            
            // 验证是否选择了题目
            if (!hasSelectedQuestions) {
                showMessage('请至少选择一种题型和数量', 'error');
                return;
            }
            
            // 显示进度条
            document.getElementById('progressContainer').style.display = 'block';
            
            // 准备请求数据
            const requestData = {
                educationStage: educationStage,
                subject: subject,
                questionTypes: questionTypes,
                paperTitle: paperTitle
            };
            
            // 发送请求生成试卷
            fetch('/api/generate_smart_paper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // 隐藏进度条
                document.getElementById('progressContainer').style.display = 'none';
                
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    // 显示成功消息
                    showMessage('试卷生成成功！', 'success');
                    
                    // 创建下载链接
                    const downloadLink = document.createElement('a');
                    downloadLink.href = data.file_url;
                    downloadLink.download = `${paperTitle}.docx`;
                    downloadLink.className = 'btn-primary';
                    downloadLink.textContent = '下载试卷';
                    downloadLink.style.marginLeft = '10px';
                    
                    // 添加到按钮区域
                    const buttonSection = document.querySelector('.buttons-section');
                    buttonSection.appendChild(downloadLink);
                    
                    // 自动点击下载
                    downloadLink.click();
                }
            })
            .catch(error => {
                console.error('Error generating paper:', error);
                document.getElementById('progressContainer').style.display = 'none';
                showMessage('生成试卷时出错，请重试', 'error');
            });
        }
        
        // 显示消息
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.className = `message-box ${type}`;
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
