<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传试卷</title>
    <link rel="stylesheet" href="/static/css/header.css?v=2.0">
    <!-- 添加 Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- 添加 SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #2F80ED;
            --secondary-color: #E6F0FF;
            --background-main: #FFFFFF;
            --text-main: #333333;
            --text-secondary: #666666;
            --text-subheading: #444444;
            --border-color: #E5E7EB;
            --border-radius: 6px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
        }
        
        body {
            font-family: "PingFang SC", "Microsoft YaHei", "Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
            color: var(--text-main);
            background-color: #f8f9fa;
            line-height: 1.6;
            font-size: 16px;
        }
        
        h1 {
            color: var(--text-main);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-main);
        }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--background-main);
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 16px;
        }
        
        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(47, 128, 237, 0.2);
            outline: none;
        }
        
        .required::after {
            content: " *";
            color: var(--error-color);
        }
        
        button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            font-weight: 500;
            font-size: 16px;
        }
        
        button:hover {
            background: #1a73e8;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .upload-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: var(--shadow-md);
        }
        
        .success { background: var(--success-color); }
        .error { background: var(--error-color); }
        .warning { background: var(--warning-color); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .parsed-title-display {
            margin-top: 10px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }
        
        .parsed-title-display p {
            margin: 7px 0;
            color: var(--text-secondary);
        }
        
        .parsed-title-display strong {
            font-weight: 600;
            color: var(--text-main);
        }
        
        .source-type-selector {
            display: flex;
            margin-bottom: 15px;
        }
        
        .source-type-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .source-type-btn:hover {
            background: #d9e9ff;
            border-color: var(--primary-color);
        }
        
        .source-type-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .source-type-btn:first-child {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        
        .source-type-btn:last-child {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .automated-detection {
            margin: 30px auto 20px;
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border: 1px solid rgba(47, 128, 237, 0.3);
            max-width: 95%;
        }
        
        .automated-detection h3 {
            margin-top: 0;
            color: var(--text-main);
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(47, 128, 237, 0.2);
            padding-bottom: 10px;
        }
        
        .automated-detection p {
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .field-match {
            background-color: #e8f5e9;
            border-color: #c8e6c9;
        }
        
        form {
            background-color: var(--background-main);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }
        
        .preview-container {
            margin: 15px 0;
            padding: 15px;
            border: 1px dashed var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--secondary-color);
        }
        
        .preview-container h3 {
            margin-top: 0;
            color: var(--text-main);
            font-weight: 600;
        }
        
        .batch-file-preview {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--background-main);
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .batch-file-preview:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .batch-file-preview h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            font-weight: 500;
        }
        
        .batch-file-preview .file-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .batch-file-preview .file-actions button {
            padding: 6px 12px;
            font-size: 0.9em;
        }
        
        .batch-file-preview .file-actions .apply-btn {
            background-color: var(--primary-color);
        }
        
        .batch-file-preview .file-actions .remove-btn {
            background-color: var(--error-color);
        }
        
        .batch-file-preview .file-actions .apply-btn:hover {
            background-color: #1a73e8;
        }
        
        .batch-file-preview .file-actions .remove-btn:hover {
            background-color: #d32f2f;
        }
        
        .batch-file-preview.collapsed .parsed-title-display {
            display: none;
        }
        
        .toggle-preview {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9em;
            padding: 0;
            font-weight: 500;
        }
        
        .toggle-preview:hover {
            text-decoration: underline;
            background: none;
        }
        
        .papers-to-upload {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--background-main);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .papers-to-upload h3 {
            margin-top: 0;
            color: var(--text-main);
        }
        
        .paper-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        .paper-item:hover {
            background-color: #f5f9fe;
        }
        
        .paper-item:last-child {
            border-bottom: none;
        }
        
        .paper-item .paper-name {
            flex: 1;
            color: var(--text-main);
        }
        
        .paper-item .remove-paper {
            color: var(--error-color);
            cursor: pointer;
            padding: 2px 5px;
            background: none;
            border: none;
            transition: color 0.2s;
        }
        
        .paper-item .remove-paper:hover {
            color: #d32f2f;
        }
        
        /* 拖拽上传相关样式 */
        #dragDropZone {
            transition: all 0.3s ease;
            position: relative;
            width: 80%;  /* 改为80%宽度 */
            margin: 0 auto;  /* 添加居中 */
            padding: 30px 20px;
            text-align: center;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            background-color: var(--background-main);
            box-sizing: border-box;  /* 添加盒模型规则 */
            display: flex;  /* 使用flex布局 */
            flex-direction: column;  /* 垂直排列子元素 */
            align-items: center;  /* 水平居中子元素 */
            justify-content: center;  /* 垂直居中子元素 */
        }
        
        #dragDropZone:hover {
            background-color: #d9e9ff;
            border-color: var(--primary-color);
        }
        
        #dragDropZone.highlight {
            background-color: #d9e9ff;
            border-color: var(--primary-color);
        }
        
        .file-upload-icon {
            color: #2F80ED;
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* 上传按钮样式统一 */
        button[type="submit"], #selectFilesBtn {
            background: var(--primary-color);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }
        
        button[type="submit"]:hover, #selectFilesBtn:hover {
            background: #1a73e8;
            box-shadow: var(--shadow-md);
        }
    </style>
    <!-- 上传试卷页面特定的头部样式 -->
    <style>
        /* 仅在上传试卷页面减小头部宽度，避免挡住下面的按钮 */
        .header {
            height: auto !important;
            padding: 10px 20px !important;
            max-width: 100% !important;
        }
        
        .header-logo {
            height: 80px !important;
        }
        
        .header-title {
            font-size: 24px !important;
        }
        
        .header-nav {
            margin-left: auto !important;
        }
        
        .header-link {
            padding: 8px 16px !important;
            font-size: 18px !important;
            margin: 0 4px !important;
        }
    </style>
</head>
<body>
    <!-- 引入公共头部组件 -->
    {% include 'header.html' %}

    <div class="automated-detection">
        <h3>自动识别功能</h3>
        <p>上传试卷后，系统将自动识别试卷的科目、地区、年份、阶段、来源和名称。</p>
        <p>您可以在上传前预览识别结果，并在需要时进行修改。</p>
    </div>

    <form id="uploadForm" method="POST" action="/upload_paper" enctype="multipart/form-data" onsubmit="return validateForm()">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="form-group">
            <label class="required">试卷文件</label>
            <div id="dragDropZone">
                <p style="margin: 0; padding: 10px;"><i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #2F80ED;"></i></p>
                <p style="margin: 5px 0;">点击选择文件或将文件拖拽到这里</p>
                <input type="file" name="paper_file" id="paperFile" required multiple="multiple"
                       accept=".pdf,.doc,.docx,.zip,.rar" style="opacity: 0; position: absolute; width: 1px; height: 1px;">
                <button type="button" id="selectFilesBtn" style="padding: 8px 15px; margin-top: 10px;">选择文件</button>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">
                支持的格式：PDF、Word文档(.doc/.docx)、压缩文件(.zip/.rar)<br>
                支持批量上传：可以一次选择多个文件进行批量上传 (按住 Ctrl 键选择多个文件)<br>
                您也可以直接将多个文件从文件夹拖拽到上面的区域
            </p>
        </div>

        <!-- 批量预览和解析区域 -->
        <div id="batchPreviewArea" class="preview-container" style="display: none;">
            <h3>批量试卷识别结果</h3>
            <div id="batchFilesPreview"></div>
            <div style="margin-top: 15px;">
                <button type="button" id="applyAllRecognizedInfo" style="margin-right: 10px;">应用全部识别结果</button>
                <button type="button" id="toggleBatchPreview" style="background: #d9e9ff; color: var(--primary-color); border: 1px solid var(--border-color);">收起预览</button>
            </div>
        </div>

        <!-- 单个文件预览和解析区域 (保留为了兼容性) -->
        <div id="parsedInfoPreview" class="preview-container" style="display: none;">
            <h3>检测到的试卷信息</h3>
            <p id="detectedTitle">检测到的标题：<span></span></p>
            <div id="recognizedInfo" class="parsed-title-display"></div>
            <button type="button" id="applyRecognizedInfo" style="margin-top: 10px;">应用识别结果</button>
        </div>

        <!-- 手动填写表单区域 -->
        <div class="form-group">
            <label class="required">试卷名称</label>
            <input type="text" name="name" id="paperName" required placeholder="例如：2024年高考模拟试卷">
        </div>

        <div class="form-group">
            <label class="required">来源类型</label>
            <div class="source-type-selector">
                <div class="source-type-btn" data-value="小中高考真题">小中高考真题</div>
                <div class="source-type-btn" data-value="地区联考">地区联考</div>
                <div class="source-type-btn" data-value="名校调考">名校调考</div>
            </div>
            <input type="hidden" name="source_type" id="sourceType" value="地区联考">
        </div>

        <div class="form-group">
            <label class="required">来源</label>
            <input type="text" name="source" id="paperSource" required placeholder="例如：湖北省新八校协作体">
        </div>

        <div class="form-group">
            <label class="required">地区</label>
            <select name="region" id="paperRegion" required>
                <option value="">请选择地区</option>
                <!-- 全国选项 -->
                <option value="全国">全国</option>
                <!-- 直辖市 -->
                <option value="北京">北京市</option>
                <option value="天津">天津市</option>
                <option value="上海">上海市</option>
                <option value="重庆">重庆市</option>
                
                <!-- 省份 -->
                <option value="河北">河北省</option>
                <option value="山西">山西省</option>
                <option value="辽宁">辽宁省</option>
                <option value="吉林">吉林省</option>
                <option value="黑龙江">黑龙江省</option>
                <option value="江苏">江苏省</option>
                <option value="浙江">浙江省</option>
                <option value="安徽">安徽省</option>
                <option value="福建">福建省</option>
                <option value="江西">江西省</option>
                <option value="山东">山东省</option>
                <option value="河南">河南省</option>
                <option value="湖北">湖北省</option>
                <option value="湖南">湖南省</option>
                <option value="广东">广东省</option>
                <option value="海南">海南省</option>
                <option value="四川">四川省</option>
                <option value="贵州">贵州省</option>
                <option value="云南">云南省</option>
                <option value="陕西">陕西省</option>
                <option value="甘肃">甘肃省</option>
                <option value="青海">青海省</option>
                <option value="台湾">台湾省</option>
                
                <!-- 自治区 -->
                <option value="内蒙古">内蒙古自治区</option>
                <option value="广西">广西壮族自治区</option>
                <option value="西藏">西藏自治区</option>
                <option value="宁夏">宁夏回族自治区</option>
                <option value="新疆">新疆维吾尔自治区</option>
                
                <!-- 特别行政区 -->
                <option value="香港">香港特别行政区</option>
                <option value="澳门">澳门特别行政区</option>
            </select>
        </div>

        <div class="form-group">
            <label class="required">科目</label>
            <select name="subject" id="paperSubject" required>
                <option value="">请选择科目</option>
                <option value="语文">语文</option>
                <option value="数学">数学</option>
                <option value="英语">英语</option>
                <option value="物理">物理</option>
                <option value="化学">化学</option>
                <option value="生物">生物</option>
                <option value="政治">政治</option>
                <option value="历史">历史</option>
                <option value="地理">地理</option>
            </select>
        </div>

        <div class="form-group">
            <label class="required">阶段</label>
            <select name="stage" id="paperStage" required>
                <option value="">请选择阶段</option>
                <option value="小学">小学</option>
                <option value="初中">初中</option>
                <option value="高中">高中</option>
            </select>
        </div>

        <div class="form-group">
            <label class="required">年份</label>
            <input type="number" name="year" id="paperYear" required min="2000" max="2100" placeholder="例如：2024">
        </div>

        <button type="submit">上传试卷</button>
    </form>

    <script>
    // 地区联考与名校调考选择
    document.querySelectorAll('.source-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.source-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('sourceType').value = this.dataset.value;
        });
    });
    
    // 默认选中第一个按钮（地区联考）
    document.querySelector('.source-type-btn').classList.add('active');

    // 为拖拽区域添加事件处理
    const dragDropZone = document.getElementById('dragDropZone');
    const fileInput = document.getElementById('paperFile');
    const selectFilesBtn = document.getElementById('selectFilesBtn');
    
    // 点击按钮打开文件选择器
    selectFilesBtn.addEventListener('click', function() {
        fileInput.click();
    });
    
    // 点击整个区域打开文件选择器
    dragDropZone.addEventListener('click', function(e) {
        if (e.target !== selectFilesBtn) {
            fileInput.click();
        }
    });
    
    // 拖拽事件处理
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dragDropZone.addEventListener(eventName, function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });
    
    // 拖拽进入和移动事件的样式处理
    ['dragenter', 'dragover'].forEach(eventName => {
        dragDropZone.addEventListener(eventName, function() {
            this.style.backgroundColor = '#d9e9ff';
            this.style.borderColor = 'var(--primary-color)';
        }, false);
    });
    
    // 拖拽离开和放下事件的样式处理
    ['dragleave', 'drop'].forEach(eventName => {
        dragDropZone.addEventListener(eventName, function() {
            this.style.backgroundColor = 'var(--background-main)';
            this.style.borderColor = 'var(--border-color)';
        }, false);
    });
    
    // 处理文件拖放
    dragDropZone.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        
        // 触发change事件，以便执行文件处理逻辑
        const event = new Event('change');
        fileInput.dispatchEvent(event);
        
        // 显示上传成功提示
        showMessage('success', `已成功选择 ${files.length} 个文件`);
    });

    // 文件选择时提取元数据 - 修改支持多文件
    document.getElementById('paperFile').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        
        // 清除之前的预览
        document.getElementById('parsedInfoPreview').style.display = 'none';
        const batchPreviewArea = document.getElementById('batchPreviewArea');
        const batchFilesPreview = document.getElementById('batchFilesPreview');
        batchFilesPreview.innerHTML = '';
        
        // 显示选择的文件数量提示
        const fileCountInfo = document.createElement('div');
        fileCountInfo.style.margin = '10px 0';
        fileCountInfo.style.padding = '10px';
        fileCountInfo.style.backgroundColor = '#d9e9ff';
        fileCountInfo.style.borderRadius = '4px';
        fileCountInfo.style.borderLeft = '4px solid var(--primary-color)';
        fileCountInfo.innerHTML = `<strong>已选择 ${files.length} 个文件进行批量上传</strong>`;
        batchFilesPreview.appendChild(fileCountInfo);
        
        // 如果有多个文件，显示批量预览区域
        if (files.length > 0) {
            batchPreviewArea.style.display = 'block';
            
            // 初始化批量识别结果存储
            window.batchRecognizedData = [];
            
            // 处理每个文件
            files.forEach((file, index) => {
                // 提取文件名作为试卷标题，用于智能识别
                let fileName = file.name.replace(/\.[^/.]+$/, ""); // 移除扩展名
                
                // 创建文件预览元素
                const filePreviewDiv = document.createElement('div');
                filePreviewDiv.className = 'batch-file-preview';
                filePreviewDiv.dataset.index = index;
                
                filePreviewDiv.innerHTML = `
                    <h4>
                        文件 ${index + 1}: ${file.name}
                        <button type="button" class="toggle-preview" data-action="collapse">收起</button>
                    </h4>
                    <div class="file-content">
                        <div class="parsed-title-display"></div>
                        <div class="file-actions">
                            <button type="button" class="apply-btn" data-index="${index}">应用此识别结果</button>
                            <button type="button" class="remove-btn" data-index="${index}">移除此文件</button>
                        </div>
                    </div>
                `;
                
                batchFilesPreview.appendChild(filePreviewDiv);
                
                // 提取并显示每个文件的元数据
                const recognizedData = extractMetadataFromTitle(fileName);
                window.batchRecognizedData[index] = recognizedData;
                
                // 将识别结果显示在预览元素中
                const parsedDisplay = filePreviewDiv.querySelector('.parsed-title-display');
                parsedDisplay.innerHTML = `
                    <p><strong>试卷名称:</strong> ${recognizedData.name}</p>
                    <p><strong>来源类型:</strong> ${recognizedData.source_type}</p>
                    <p><strong>来源:</strong> ${recognizedData.source}</p>
                    <p><strong>地区:</strong> ${recognizedData.region || '未识别'}</p>
                    <p><strong>科目:</strong> ${recognizedData.subject || '未识别'}</p>
                    <p><strong>阶段:</strong> ${recognizedData.stage || '未识别'}</p>
                    <p><strong>年份:</strong> ${recognizedData.year || '未识别'}</p>
                `;
                
                // 添加收起/展开预览的事件处理
                const toggleBtn = filePreviewDiv.querySelector('.toggle-preview');
                toggleBtn.addEventListener('click', function() {
                    const content = this.closest('.batch-file-preview').querySelector('.file-content');
                    if (this.dataset.action === 'collapse') {
                        content.style.display = 'none';
                        this.textContent = '展开';
                        this.dataset.action = 'expand';
                    } else {
                        content.style.display = 'block';
                        this.textContent = '收起';
                        this.dataset.action = 'collapse';
                    }
                });
                
                // 添加应用当前文件识别结果的处理
                const applyBtn = filePreviewDiv.querySelector('.apply-btn');
                applyBtn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    applyRecognizedDataToForm(window.batchRecognizedData[index]);
                    showMessage('success', `已应用文件 ${index + 1} 的识别结果`);
                });
                
                // 添加移除当前文件的处理
                const removeBtn = filePreviewDiv.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const dataTransfer = new DataTransfer();
                    
                    Array.from(document.getElementById('paperFile').files)
                        .filter((_, i) => i !== index)
                        .forEach(file => dataTransfer.items.add(file));
                    
                    document.getElementById('paperFile').files = dataTransfer.files;
                    
                    // 如果移除后没有文件了，隐藏预览区域
                    if (dataTransfer.files.length === 0) {
                        batchPreviewArea.style.display = 'none';
                    } else {
                        // 刷新批量预览
                        document.getElementById('paperFile').dispatchEvent(new Event('change'));
                    }
                });
            });
        } else if (files.length === 1) {
            // 如果只有一个文件，使用原来的单文件预览
            const file = files[0];
            // 显示文件预览
            const fileInfo = document.createElement('p');
            fileInfo.textContent = `已选择: ${file.name}`;
            fileInfo.style.color = 'var(--text-secondary)';
            fileInfo.style.marginTop = '5px';
            fileInfo.className = 'file-info';
            
            // 移除之前的文件信息（如果有）
            const oldInfo = this.parentNode.querySelector('.file-info');
            if (oldInfo) oldInfo.remove();
            this.parentNode.appendChild(fileInfo);

            // 提取文件名作为试卷标题，用于智能识别
            const fileName = file.name.replace(/\.[^/.]+$/, ""); // 移除扩展名
            const recognizedData = extractMetadataFromTitle(fileName);
            window.recognizedData = recognizedData;
            
            // 显示单文件预览
            document.getElementById('parsedInfoPreview').style.display = 'block';
            document.getElementById('detectedTitle').querySelector('span').textContent = recognizedData.name;
            
            // 渲染识别结果
            const recognizedInfo = document.getElementById('recognizedInfo');
            recognizedInfo.innerHTML = `
                <p><strong>试卷名称:</strong> ${recognizedData.name}</p>
                <p><strong>来源类型:</strong> ${recognizedData.source_type}</p>
                <p><strong>来源:</strong> ${recognizedData.source}</p>
                <p><strong>地区:</strong> ${recognizedData.region || '未识别'}</p>
                <p><strong>科目:</strong> ${recognizedData.subject || '未识别'}</p>
                <p><strong>阶段:</strong> ${recognizedData.stage || '未识别'}</p>
                <p><strong>年份:</strong> ${recognizedData.year || '未识别'}</p>
            `;
        }
    });
    
    // 添加收起/展开批量预览区域的功能
    document.getElementById('toggleBatchPreview').addEventListener('click', function() {
        const previewContent = document.getElementById('batchFilesPreview');
        if (previewContent.style.display === 'none') {
            previewContent.style.display = 'block';
            this.textContent = '收起预览';
        } else {
            previewContent.style.display = 'none';
            this.textContent = '展开预览';
        }
    });
    
    // 应用所有识别结果的第一个到表单
    document.getElementById('applyAllRecognizedInfo').addEventListener('click', function() {
        if (window.batchRecognizedData && window.batchRecognizedData.length > 0) {
            // 默认应用第一个文件的识别结果
            applyRecognizedDataToForm(window.batchRecognizedData[0]);
            showMessage('success', '已应用第一个文件的识别结果');
        }
    });

    // 从标题中提取元数据
    function extractMetadataFromTitle(title) {
        // 清除特定模式，如【KS5U 高考】
        title = title.replace(/【KS5U\s+高考】|【KS5U】|【高考】|【真题】/g, '').trim();
        
        // 清除文件名中的"ks5u"字符串（不区分大小写）
        title = title.replace(/ks5u/gi, '');
        title = title.trim();
        
        // 创建一个包含提取结果的对象
        const result = {
            name: title,
            region: '',
            subject: '',
            stage: '',
            source: '',
            source_type: '地区联考', // 默认来源类型
            year: ''
        };
        
        // 提取年份
        const yearMatch = title.match(/\b(20\d{2})\b/);
        if (yearMatch) {
            result.year = yearMatch[1];
        }

        // 首先尝试直接从文件名中提取科目信息
        function extractSubject(title) {
            // 1. 首先尝试匹配"XX科目 PDF版"或"XX科目 Word版"这样的模式
            const subjectWithFormat = /(?:语文|数学|英语|物理|化学|生物|政治|历史|地理)(?:\s*(?:PDF|Word|DOC|试卷|试题))/i;
            const formatMatch = title.match(subjectWithFormat);
            if (formatMatch) {
                return formatMatch[0].match(/(?:语文|数学|英语|物理|化学|生物|政治|历史|地理)/)[0];
            }

            // 2. 尝试匹配完整的科目名称
            const fullSubjects = /(语文|数学|英语|物理|化学|生物|政治|历史|地理)(?!\w)/;
            const fullMatch = title.match(fullSubjects);
            if (fullMatch) {
                return fullMatch[1];
            }

            // 3. 尝试匹配科目简称
            const shortSubjects = /(?:^|\s)(数|语|英|物|化|生|政|史|地)(?=\s|$)/;
            const shortMatch = title.match(shortSubjects);
            if (shortMatch) {
                const subjectMap = {
                    '数': '数学',
                    '语': '语文',
                    '英': '英语',
                    '物': '物理',
                    '化': '化学',
                    '生': '生物',
                    '政': '政治',
                    '史': '历史',
                    '地': '地理'
                };
                return subjectMap[shortMatch[1]];
            }

            return '';
        }

        // 验证识别到的科目
        function validateSubject(subject, title) {
            if (!subject) return '';

            // 科目特征关键词
            const subjectFeatures = {
                '语文': ['文言文', '古诗', '阅读理解', '作文', '散文', '诗歌', '标点符号', '修辞', '语法'],
                '数学': ['函数', '方程', '几何', '代数', '导数', '积分', '概率', '三角', '数列', '集合'],
                '英语': ['reading', 'writing', 'grammar', 'vocabulary', '阅读', '写作', '语法', '听力', 'listening'],
                '物理': ['力学', '电学', '热学', '光学', '动能', '势能', '电压', '电流', '磁场', '功率'],
                '化学': ['化合物', '元素', '分子', '原子', '氧化', '还原', '酸碱', '离子', '浓度', '化学式'],
                '生物': ['细胞', '基因', '遗传', '进化', '光合', '呼吸', '生态', '酶', '激素', 'DNA'],
                '政治': ['哲学', '经济', '思想', '文化', '社会', '法律', '辩证', '唯物', '民主', '法制'],
                '历史': ['朝代', '年代', '革命', '战争', '文化', '制度', '改革', '帝国', '文明', '王朝'],
                '地理': ['地形', '气候', '人口', '资源', '环境', '地图', '地貌', '经纬度', '地球', '海洋']
            };

            // 检查文件名中的特征关键词
            const keywords = subjectFeatures[subject] || [];
            for (const keyword of keywords) {
                if (title.toLowerCase().includes(keyword.toLowerCase())) {
                    return subject; // 找到特征关键词，确认科目正确
                }
            }

            // 如果没有找到特征关键词，检查是否有明确的科目标识
            const explicitSubject = new RegExp(`${subject}(?:\\s*(?:试卷|试题|测试|考试))`);
            if (explicitSubject.test(title)) {
                return subject;
            }

            // 如果既没有特征关键词，也没有明确标识，返回空
            // 这样会触发手动选择科目
            return '';
        }

        // 提取科目并验证
        const subject = extractSubject(title);
        const validatedSubject = validateSubject(subject, title);

        // 提取其他元数据
        const patterns = {
            region: /(北京|天津|上海|重庆|河北|山西|辽宁|吉林|黑龙江|江苏|浙江|安徽|福建|江西|山东|河南|湖北|湖南|广东|海南|四川|贵州|云南|西藏|陕西|甘肃|青海|台湾|内蒙古|广西|宁夏|新疆|香港|澳门)(省|市|自治区|特别行政区)?/,
            year: /(\d{4})(-\d{4})?/,
            stage: /(小学|初中|高中|高一|高二|高三)(上学期|下学期)?/,
            source_type: /(联考|调考|真题)/,
            school: /(大学|中学|小学|附属|实验|一中|二中|三中|四中|五中|六中|七中|八中|九中|十中)/,
            exam_keywords: /(高考|中考|小升初|会考|模拟|押题)/
        };

        // 提取匹配结果
        const extracted = {};
        for (const [key, pattern] of Object.entries(patterns)) {
            const match = title.match(pattern);
            if (match) {
                extracted[key] = match[0];
            }
        }

        // 检查标题中是否包含"全国"关键词
        if (title.includes('全国')) {
            extracted.region = '全国';
        }

        // 处理年级和学期信息
        if (extracted.stage) {
            if (/高一|高二|高三/.test(extracted.stage)) {
                extracted.stage = '高中';
            } else if (/初一|初二|初三/.test(extracted.stage)) {
                extracted.stage = '初中';
            }
        } else {
            // 根据考试类型自动设置学段
            if (extracted.exam_keywords) {
                if (/高考/.test(extracted.exam_keywords)) {
                    extracted.stage = '高中';
                } else if (/中考/.test(extracted.exam_keywords)) {
                    extracted.stage = '初中';
                } else if (/小升初/.test(extracted.exam_keywords)) {
                    extracted.stage = '小学';
                }
            }
        }

        // 处理来源类型和来源
        let sourceType = '地区联考';
        let source = '';

        if (extracted.exam_keywords && /高考|中考|小升初/.test(extracted.exam_keywords)) {
            sourceType = '小中高考真题';  // 恢复为小中高考真题
            source = (extracted.region || '') + extracted.exam_keywords;
        } else if (extracted.school) {
            sourceType = '名校调考';
            const schoolMatch = title.match(new RegExp(`${extracted.region || ''}[^\\d]+${extracted.school}[^\\d]*`));
            source = schoolMatch ? schoolMatch[0].trim() : extracted.school;
        } else if (extracted.region) {
            const regionExtra = title.match(new RegExp(`${extracted.region}[^\\d]+(?=\\d|${validatedSubject}|${extracted.stage}|联考|调考)`));
            source = regionExtra ? regionExtra[0].trim() : extracted.region;
        }

        // 更新来源类型
        if (extracted.source_type) {
            if (extracted.source_type.includes('联考')) sourceType = '地区联考';
            else if (extracted.source_type.includes('调考')) sourceType = '名校调考';
            else if (extracted.source_type.includes('真题')) sourceType = '小中高考真题';  // 恢复为小中高考真题
        }

        // 返回识别结果
        return {
            name: title,
            source_type: sourceType,
            source: source,
            region: extracted.region ? extracted.region.replace(/(省|市|自治区|特别行政区)$/, '') : '',
            subject: validatedSubject,
            stage: extracted.stage ? extracted.stage.replace(/(上学期|下学期)$/, '') : '',
            year: extracted.year ? extracted.year.split('-')[0] : ''
        };
    }

    // 将识别数据应用到表单的通用函数
    function applyRecognizedDataToForm(recognizedData) {
        if (recognizedData) {
            // 设置表单值
            document.getElementById('paperName').value = recognizedData.name;
            document.getElementById('paperSource').value = recognizedData.source;
            
            // 设置下拉选择框
            if (recognizedData.region) {
                document.getElementById('paperRegion').value = recognizedData.region;
            }
            if (recognizedData.subject) {
                document.getElementById('paperSubject').value = recognizedData.subject;
            }
            if (recognizedData.stage) {
                document.getElementById('paperStage').value = recognizedData.stage;
            }
            if (recognizedData.year) {
                document.getElementById('paperYear').value = recognizedData.year;
            }
            
            // 设置来源类型
            document.getElementById('sourceType').value = recognizedData.source_type;
            document.querySelectorAll('.source-type-btn').forEach(btn => {
                if (btn.dataset.value === recognizedData.source_type) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
    }

    // 原始的应用识别结果按钮 (保留为了兼容性)
    document.getElementById('applyRecognizedInfo').addEventListener('click', function() {
        if (window.recognizedData) {
            applyRecognizedDataToForm(window.recognizedData);
            showMessage('success', '已应用识别结果');
        }
    });

    function clearFilePreviews() {
        document.querySelectorAll('.file-info').forEach(el => el.remove());
        document.getElementById('batchPreviewArea').style.display = 'none';
    }

    function clearRecognizedInfo() {
        document.getElementById('parsedInfoPreview').style.display = 'none';
    }

    function validateForm() {
        // 显示加载状态
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="spinner"></i> 上传中...';
        submitBtn.disabled = true;
        
        // 获取表单数据
        const region = document.getElementById('paperRegion').value;
        const stage = document.getElementById('paperStage').value;
        const sourceType = document.getElementById('sourceType').value;
        const source = document.getElementById('paperSource').value;
        const year = document.getElementById('paperYear').value;
        const files = document.getElementById('paperFile').files;
        
        // 验证必填字段
        let isValid = true;
        let errors = [];
        
        // 检查是否有选择至少一个文件
        if (files.length === 0) {
            isValid = false;
            errors.push('请选择至少一个文件上传');
        }
        
        // 检查其他必填字段
        if (!region) { isValid = false; errors.push('请选择地区'); }
        if (!stage) { isValid = false; errors.push('请选择学段'); }
        if (!source) { isValid = false; errors.push('请输入来源'); }
        if (!year) { isValid = false; errors.push('请输入年份'); }
        
        // 如果验证不通过，显示错误信息
        if (!isValid) {
            const errorMsg = errors.join('<br>');
            Swal.fire({
                icon: 'error',
                title: '表单验证失败',
                html: errorMsg,
                confirmButtonText: '确定',
                confirmButtonColor: 'var(--primary-color)'
            });
            
            // 恢复按钮状态
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            return false;
        }
        
        // 显示上传信息
        if (files.length > 1) {
            Swal.fire({
                icon: 'info',
                title: '批量上传中',
                text: `正在上传 ${files.length} 个文件，请耐心等待...`,
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        } else {
            Swal.fire({
                icon: 'info',
                title: '上传中',
                text: '正在上传文件，请稍候...',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }
        
        // 创建FormData对象
        const formData = new FormData();
        formData.append('region', region);
        formData.append('stage', stage);
        formData.append('source_type', sourceType);
        formData.append('source', source);
        formData.append('year', year);
        
        // 为每个文件提取科目信息并添加到FormData
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            // 提取文件名作为试卷名称（去除扩展名）
            const paperName = file.name.replace(/\.[^/.]+$/, "").trim();
            
            // 从文件名中提取科目信息
            const metadata = extractMetadataFromTitle(paperName);
            let subject = metadata.subject;
            
            // 如果没有识别出科目，尝试从文件名中进行更严格的匹配
            if (!subject) {
                const subjectMatch = paperName.match(/(语文|数学|英语|物理|化学|生物|政治|历史|地理)(?:\s*(?:试卷|试题|测试|考试))?/);
                if (subjectMatch) {
                    subject = subjectMatch[1];
                }
            }
            
            // 如果仍然没有识别出科目，使用默认选择的科目
            if (!subject) {
                subject = document.getElementById('paperSubject').value;
            }
            
            // 如果还是没有科目信息，返回错误
            if (!subject) {
                Swal.fire({
                    icon: 'error',
                    title: '上传失败',
                    text: `无法识别文件 "${file.name}" 的科目，请确保文件名包含科目信息或手动选择科目。`,
                    confirmButtonText: '确定',
                    confirmButtonColor: 'var(--primary-color)'
                });
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return false;
            }
            
            // 为每个文件添加单独的元数据
            formData.append(`paper_file_${i}`, file);
            formData.append(`paper_name_${i}`, paperName);
            formData.append(`paper_subject_${i}`, subject);
        }
        
        // 添加文件总数
        formData.append('file_count', files.length);
        
        // 发送AJAX请求
        fetch('/upload_paper', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // 恢复按钮状态
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (data.success) {
                // 显示成功消息
                Swal.fire({
                    icon: 'success',
                    title: '上传成功',
                    text: data.message,
                    confirmButtonText: '确定',
                    confirmButtonColor: 'var(--primary-color)'
                }).then(() => {
                    // 重置表单和预览
                    document.getElementById('uploadForm').reset();
                    clearFilePreviews();
                    clearRecognizedInfo();
                });
            } else {
                // 显示错误消息
                Swal.fire({
                    icon: 'error',
                    title: '上传失败',
                    text: data.error,
                    confirmButtonText: '确定',
                    confirmButtonColor: 'var(--primary-color)'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // 恢复按钮状态
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            // 显示错误消息
            Swal.fire({
                icon: 'error',
                title: '上传失败',
                text: '网络错误，请稍后重试',
                confirmButtonText: '确定',
                confirmButtonColor: 'var(--primary-color)'
            });
        });
        
        return false; // 阻止表单的默认提交行为
    }

    function showMessage(type, text) {
        const existingMsg = document.querySelector('.upload-message');
        if (existingMsg) existingMsg.remove();

        const msgDiv = document.createElement('div');
        msgDiv.className = `upload-message ${type}`;
        msgDiv.textContent = text;
        
        document.body.appendChild(msgDiv);
        setTimeout(() => msgDiv.remove(), 3000);
    }
    </script>
</body>
</html>