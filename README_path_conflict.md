# 文件路径冲突问题及修复指南

## 问题描述

经检查发现系统中存在文件路径冲突问题：多个不同的试卷记录共享同一个文件路径。例如：

1. ID 37 - 湖北省圆创高中名校联盟2025届高三下学期2月第三次联合测评试题 英语 PDF版含解析（含听力）
   - 文件路径: `uploads/papers/20250316_091640_1011_2021.docx`

2. ID 25956 - 2021年湖北省十堰市中考生物真题（解析版）
   - 文件路径: 与上面完全相同 `uploads/papers/20250316_091640_1011_2021.docx`

这导致用户在尝试下载英语试卷时，可能会获取到生物试卷，反之亦然。

## 修复方案

我们提供了两个关键工具来解决这个问题：

1. **修复文件路径冲突**: `fix_conflicting_paths.py`
   - 检测并修复数据库中多个试卷记录共享同一个文件路径的情况
   - 为冲突的记录分配唯一的新路径

2. **修复文件实际匹配**: `fix_paper_matches.py`
   - 在修复路径冲突后，根据试卷名称等信息找到最合适的实际文件
   - 更新数据库记录指向正确的文件

## 修复步骤

### 1. 运行路径冲突修复工具

首先运行路径冲突检测工具，查看冲突情况但不做实际修改：

```bash
python3 fix_conflicting_paths.py
```

查看输出的冲突列表，确认修复方案。然后执行实际修复：

```bash
python3 fix_conflicting_paths.py --confirm
```

该工具会：
- 自动备份数据库
- 记录冲突路径信息到日志文件
- 为冲突记录分配新的唯一路径

### 2. 运行文件匹配工具

修复路径冲突后，运行文件匹配工具，为每个试卷记录找到合适的文件：

```bash
python3 fix_paper_matches.py
```

该工具会：
- 自动备份数据库
- 分析每个试卷记录的名称、科目、地区等信息
- 寻找最匹配的文件并更新数据库
- 生成详细日志

### 3. 重启应用

修复完成后，重启应用以应用更改：

```bash
# 如果使用systemd管理服务
sudo systemctl restart zujuanwang

# 或者直接重启Python应用
cd /path/to/app
kill $(pgrep -f "python3 app.py") || true
nohup python3 app.py > app.log 2>&1 &
```

## 预防措施

为防止此类问题再次发生，我们已对代码进行以下修改：

1. 改进了`download_paper`函数，当文件不存在时提供更详细的错误信息，包括可能的冲突原因
2. 添加了`DownloadLog`模型类以记录下载活动
3. 提供了新的管理工具用于定期检查和维护文件路径

## 后续维护建议

1. 定期运行冲突检测工具：
   ```bash
   python3 fix_conflicting_paths.py
   ```

2. 使用管理界面上传缺失的文件或替换不正确的文件

3. 考虑调整上传流程，确保每个试卷记录获得唯一的文件路径 